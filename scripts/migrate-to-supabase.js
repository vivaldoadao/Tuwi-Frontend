/**
 * Script de Migra√ß√£o de Dados Mock para Supabase
 * 
 * Este script migra todos os dados mock da aplica√ß√£o para o banco de dados Supabase
 * ATEN√á√ÉO: Execute apenas em ambiente de desenvolvimento/teste
 */

const { createClient } = require('@supabase/supabase-js')
const fs = require('fs')
const path = require('path')

// Configura√ß√£o do Supabase (usando service role key para opera√ß√µes administrativas)
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('‚ùå Erro: Vari√°veis de ambiente NEXT_PUBLIC_SUPABASE_URL e SUPABASE_SERVICE_ROLE_KEY s√£o obrigat√≥rias')
  process.exit(1)
}

const supabase = createClient(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})

// Dados Mock (copiados e adaptados do lib/data.ts)
const mockProducts = [
  {
    name: "Tran√ßas Box Braids Premium",
    description: "Tran√ßas box braids de alta qualidade com fibra sint√©tica premium",
    long_description: "Nossas Box Braids Premium s√£o feitas com fibra sint√©tica de alta qualidade que imita perfeitamente o cabelo natural. Ideal para quem busca um visual moderno e prote√ß√£o para os fios naturais. Dura√ß√£o m√©dia de 2-3 meses com cuidados adequados.",
    price: 89.90,
    images: ["/placeholder.svg?height=400&width=400&text=Box+Braids+Premium"],
    category: "Tran√ßas",
    stock_quantity: 50
  },
  {
    name: "Twist Braids Naturais",
    description: "Twist braids com apar√™ncia natural e toque suave",
    long_description: "As Twist Braids Naturais oferecem um visual elegante e sofisticado. Feitas com fibra de alt√≠ssima qualidade que proporciona movimento natural e brilho saud√°vel. Perfeitas para um look profissional ou casual.",
    price: 79.90,
    images: ["/placeholder.svg?height=400&width=400&text=Twist+Braids"],
    category: "Tran√ßas",
    stock_quantity: 45
  },
  {
    name: "Crochet Braids Cacheadas",
    description: "Crochet braids com textura cacheada para volume natural",
    long_description: "Para quem ama cachos! Nossas Crochet Braids Cacheadas proporcionam volume e movimento naturais. F√°ceis de manter e estilizar, s√£o perfeitas para quem quer praticidade sem abrir m√£o da beleza.",
    price: 95.90,
    images: ["/placeholder.svg?height=400&width=400&text=Crochet+Cacheadas"],
    category: "Cachos",
    stock_quantity: 30
  },
  {
    name: "Fulani Braids Decoradas",
    description: "Tran√ßas Fulani com decora√ß√µes douradas tradicionais",
    long_description: "As Fulani Braids s√£o uma homenagem √† cultura africana tradicional. Nossas tran√ßas v√™m com decora√ß√µes douradas aut√™nticas e s√£o ideais para ocasi√µes especiais ou para quem quer expressar sua conex√£o com as ra√≠zes africanas.",
    price: 120.00,
    images: ["/placeholder.svg?height=400&width=400&text=Fulani+Braids"],
    category: "Tradicionais",
    stock_quantity: 25
  },
  {
    name: "Goddess Locs Luxo",
    description: "Goddess locs com textura luxuosa e acabamento perfeito",
    long_description: "As Goddess Locs Luxo combinam a beleza dos locs tradicionais com toques modernos. Textura suave ao toque e apar√™ncia sofisticada. Ideais para quem busca eleg√¢ncia e praticidade no dia a dia.",
    price: 150.00,
    images: ["/placeholder.svg?height=400&width=400&text=Goddess+Locs"],
    category: "Locs",
    stock_quantity: 20
  }
]

const mockUsers = [
  {
    id: 'user-admin-001',
    email: 'admin@wilnara.com',
    name: 'Administrador Wilnara',
    role: 'admin'
  },
  {
    id: 'user-braider-001',
    email: 'maria@wilnara.com',
    name: 'Maria Silva Santos',
    role: 'braider',
    phone: '(11) 99999-1234'
  },
  {
    id: 'user-braider-002',
    email: 'ana@wilnara.com',
    name: 'Ana Costa Lima',
    role: 'braider',
    phone: '(21) 99999-5678'
  },
  {
    id: 'user-customer-001',
    email: 'cliente@exemplo.com',
    name: 'Cliente Exemplo',
    role: 'customer',
    phone: '(11) 99999-0000'
  }
]

const mockBraiders = [
  {
    user_id: 'user-braider-001',
    bio: 'Especialista em tran√ßas africanas com mais de 10 anos de experi√™ncia. Formada pela Escola de Beleza Afro-Brasileira e com diversos cursos de aperfei√ßoamento. Apaixonada por valorizar a beleza natural da mulher negra atrav√©s das tran√ßas tradicionais e modernas.',
    location: 'S√£o Paulo, SP - Zona Sul',
    contact_phone: '(11) 99999-1234',
    status: 'approved',
    portfolio_images: [
      '/placeholder.svg?height=300&width=300&text=Portfolio+Maria+1',
      '/placeholder.svg?height=300&width=300&text=Portfolio+Maria+2',
      '/placeholder.svg?height=300&width=300&text=Portfolio+Maria+3'
    ],
    average_rating: 4.8,
    total_reviews: 45
  },
  {
    user_id: 'user-braider-002',
    bio: 'Trancista profissional especializada em box braids e twist braids. Com forma√ß√£o em est√©tica capilar e 8 anos de experi√™ncia, atende tanto em domic√≠lio quanto em sal√£o pr√≥prio. Focada em proporcionar n√£o apenas beleza, mas tamb√©m sa√∫de capilar para suas clientes.',
    location: 'Rio de Janeiro, RJ - Zona Norte',
    contact_phone: '(21) 99999-5678',
    status: 'approved',
    portfolio_images: [
      '/placeholder.svg?height=300&width=300&text=Portfolio+Ana+1',
      '/placeholder.svg?height=300&width=300&text=Portfolio+Ana+2'
    ],
    average_rating: 4.9,
    total_reviews: 32
  }
]

const mockServices = [
  // Servi√ßos da Maria
  {
    braider_user_id: 'user-braider-001',
    name: 'Box Braids Completas',
    description: 'Box braids tradicionais com instala√ß√£o completa e finaliza√ß√£o profissional',
    price: 150.00,
    duration_minutes: 360,
    image_url: '/placeholder.svg?height=200&width=200&text=Box+Braids+Maria'
  },
  {
    braider_user_id: 'user-braider-001',
    name: 'Twist Braids M√©dias',
    description: 'Twist braids de tamanho m√©dio, ideais para o dia a dia',
    price: 120.00,
    duration_minutes: 300,
    image_url: '/placeholder.svg?height=200&width=200&text=Twist+Braids+Maria'
  },
  {
    braider_user_id: 'user-braider-001',
    name: 'Fulani Braids Decoradas',
    description: 'Fulani braids com decora√ß√µes douradas tradicionais',
    price: 200.00,
    duration_minutes: 420,
    image_url: '/placeholder.svg?height=200&width=200&text=Fulani+Braids+Maria'
  },
  // Servi√ßos da Ana
  {
    braider_user_id: 'user-braider-002',
    name: 'Box Braids Jumbo',
    description: 'Box braids jumbo para um visual mais despojado e moderno',
    price: 130.00,
    duration_minutes: 240,
    image_url: '/placeholder.svg?height=200&width=200&text=Box+Jumbo+Ana'
  },
  {
    braider_user_id: 'user-braider-002',
    name: 'Crochet Braids',
    description: 'Crochet braids com textura natural e volume',
    price: 110.00,
    duration_minutes: 180,
    image_url: '/placeholder.svg?height=200&width=200&text=Crochet+Ana'
  }
]

// Fun√ß√µes auxiliares
async function clearDatabase() {
  console.log('üßπ Limpando dados existentes...')
  
  const tables = [
    'bookings',
    'braider_availability', 
    'services',
    'braiders',
    'products',
    'users'
  ]
  
  for (const table of tables) {
    const { error } = await supabase
      .from(table)
      .delete()
      .neq('id', 'impossible-id') // Deleta todos os registros
    
    if (error && !error.message.includes('No rows found')) {
      console.warn(`‚ö†Ô∏è  Aviso ao limpar tabela ${table}:`, error.message)
    }
  }
}

async function insertUsers() {
  console.log('üë• Inserindo usu√°rios...')
  
  for (const user of mockUsers) {
    // Primeiro, criar o usu√°rio na tabela auth.users (simulado)
    const { data, error } = await supabase
      .from('users')
      .insert([{
        id: user.id,
        email: user.email,
        name: user.name,
        role: user.role,
        phone: user.phone || null
      }])
      .select()
    
    if (error) {
      console.error(`‚ùå Erro ao inserir usu√°rio ${user.email}:`, error.message)
    } else {
      console.log(`‚úÖ Usu√°rio ${user.email} inserido com sucesso`)
    }
  }
}

async function insertProducts() {
  console.log('üì¶ Inserindo produtos...')
  
  const { data, error } = await supabase
    .from('products')
    .insert(mockProducts)
    .select()
  
  if (error) {
    console.error('‚ùå Erro ao inserir produtos:', error.message)
    return []
  } else {
    console.log(`‚úÖ ${data.length} produtos inseridos com sucesso`)
    return data
  }
}

async function insertBraiders() {
  console.log('üíá‚Äç‚ôÄÔ∏è Inserindo perfis de trancistas...')
  
  const insertedBraiders = []
  
  for (const braider of mockBraiders) {
    const { data, error } = await supabase
      .from('braiders')
      .insert([braider])
      .select()
    
    if (error) {
      console.error(`‚ùå Erro ao inserir trancista:`, error.message)
    } else {
      console.log(`‚úÖ Trancista inserido com sucesso`)
      insertedBraiders.push(data[0])
    }
  }
  
  return insertedBraiders
}

async function insertServices(braiders) {
  console.log('üîß Inserindo servi√ßos...')
  
  const insertedServices = []
  
  for (const service of mockServices) {
    // Encontrar o braider_id pelo user_id
    const braider = braiders.find(b => b.user_id === service.braider_user_id)
    
    if (!braider) {
      console.error(`‚ùå Trancista n√£o encontrado para user_id: ${service.braider_user_id}`)
      continue
    }
    
    const serviceData = {
      braider_id: braider.id,
      name: service.name,
      description: service.description,
      price: service.price,
      duration_minutes: service.duration_minutes,
      image_url: service.image_url
    }
    
    const { data, error } = await supabase
      .from('services')
      .insert([serviceData])
      .select()
    
    if (error) {
      console.error(`‚ùå Erro ao inserir servi√ßo ${service.name}:`, error.message)
    } else {
      console.log(`‚úÖ Servi√ßo ${service.name} inserido com sucesso`)
      insertedServices.push(data[0])
    }
  }
  
  return insertedServices
}

async function insertBraiderAvailability(braiders) {
  console.log('üìÖ Inserindo disponibilidades das trancistas...')
  
  const today = new Date()
  const availabilities = []
  
  // Criar disponibilidades para os pr√≥ximos 30 dias
  for (const braider of braiders) {
    for (let i = 1; i <= 30; i++) {
      const date = new Date(today)
      date.setDate(today.getDate() + i)
      
      // Pular domingos
      if (date.getDay() === 0) continue
      
      // Hor√°rios dispon√≠veis (9:00 √†s 17:00, intervalos de 1 hora)
      const timeSlots = [
        '09:00', '10:00', '11:00', '12:00', 
        '14:00', '15:00', '16:00', '17:00'
      ]
      
      for (const startTime of timeSlots) {
        const [hour, minute] = startTime.split(':')
        const endHour = parseInt(hour) + 1
        const endTime = `${endHour.toString().padStart(2, '0')}:${minute}`
        
        availabilities.push({
          braider_id: braider.id,
          available_date: date.toISOString().split('T')[0],
          start_time: startTime,
          end_time: endTime,
          is_booked: false
        })
      }
    }
  }
  
  // Inserir em lotes para evitar timeout
  const batchSize = 100
  for (let i = 0; i < availabilities.length; i += batchSize) {
    const batch = availabilities.slice(i, i + batchSize)
    
    const { error } = await supabase
      .from('braider_availability')
      .insert(batch)
    
    if (error) {
      console.error(`‚ùå Erro ao inserir lote de disponibilidades:`, error.message)
    } else {
      console.log(`‚úÖ Lote de ${batch.length} disponibilidades inserido`)
    }
  }
  
  console.log(`‚úÖ Total de ${availabilities.length} disponibilidades inseridas`)
}

async function createSampleBookings(braiders, services) {
  console.log('üìã Criando agendamentos de exemplo...')
  
  const sampleBookings = [
    {
      service_id: services[0]?.id,
      client_id: 'user-customer-001',
      braider_id: braiders[0]?.id,
      booking_date: '2024-12-01',
      booking_time: '10:00',
      service_type: 'trancista',
      client_name: 'Cliente Exemplo',
      client_email: 'cliente@exemplo.com',
      client_phone: '(11) 99999-0000',
      status: 'confirmed',
      total_amount: 150.00,
      notes: 'Primeira vez fazendo box braids'
    }
  ]
  
  for (const booking of sampleBookings) {
    if (!booking.service_id || !booking.braider_id) {
      console.log('‚ö†Ô∏è  Pulando agendamento - servi√ßo ou trancista n√£o encontrado')
      continue
    }
    
    const { data, error } = await supabase
      .from('bookings')
      .insert([booking])
      .select()
    
    if (error) {
      console.error('‚ùå Erro ao criar agendamento:', error.message)
    } else {
      console.log('‚úÖ Agendamento de exemplo criado')
    }
  }
}

// Fun√ß√£o principal
async function main() {
  console.log('üöÄ Iniciando migra√ß√£o de dados mock para Supabase...\n')
  
  try {
    // 1. Limpar dados existentes
    await clearDatabase()
    
    // 2. Inserir usu√°rios
    await insertUsers()
    
    // 3. Inserir produtos
    const products = await insertProducts()
    
    // 4. Inserir trancistas
    const braiders = await insertBraiders()
    
    // 5. Inserir servi√ßos
    const services = await insertServices(braiders)
    
    // 6. Inserir disponibilidades
    await insertBraiderAvailability(braiders)
    
    // 7. Criar agendamentos de exemplo
    await createSampleBookings(braiders, services)
    
    console.log('\nüéâ Migra√ß√£o conclu√≠da com sucesso!')
    console.log('\nüìä Resumo:')
    console.log(`   ‚Ä¢ ${mockUsers.length} usu√°rios`)
    console.log(`   ‚Ä¢ ${products.length} produtos`)
    console.log(`   ‚Ä¢ ${braiders.length} trancistas`)
    console.log(`   ‚Ä¢ ${services.length} servi√ßos`)
    console.log(`   ‚Ä¢ Disponibilidades para 30 dias`)
    console.log(`   ‚Ä¢ Agendamentos de exemplo`)
    
  } catch (error) {
    console.error('‚ùå Erro durante a migra√ß√£o:', error)
    process.exit(1)
  }
}

// Verificar se o script est√° sendo executado diretamente
if (require.main === module) {
  main()
}

module.exports = { main }